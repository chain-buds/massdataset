---
title: "Process mass_dataset using tidyverse functions"
author:
- name: Xiaotao Shen (https://www.shenxt.info/)
date: "Created on 2021-12-04 and updated on `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: no
  pdf_document:
    toc: no
vignette: >
  %\VignetteIndexEntry{tidyverse_verse}
  %\VignettePackage{massdataset}
  % \VignetteEngine{knitr::rmarkdown}
  % \usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = TRUE,
  out.width = "100%"
)
```

# **Introduction**

`mass_dataset` can be processed using most of the functions from `tidyverse` (`dplyr`).  Before use the functions from `tidyverse`, we need to tell it which dataset we want to process (`activate_mass_dataset()`). 

# **Data preparation**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
library(massdataset)
library(tidyverse)

data("expression_data")
data("sample_info")
data("sample_info_note")
data("variable_info")
data("variable_info_note")

object =
  create_mass_dataset(
    expression_data = expression_data,
    sample_info = sample_info,
    variable_info = variable_info,
    sample_info_note = sample_info_note,
    variable_info_note = variable_info_note
  )
```

# **filter() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object = 
object %>% 
  activate_mass_dataset(what = "sample_info")
object@activated
```

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object = 
object %>% 
  activate_mass_dataset(what = "variable_info")
object@activated
```

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object = 
object %>% 
  activate_mass_dataset(what = "expression_data")
object@activated
```

## Filter samples

Only remain QC samples.

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object2 = 
object %>% 
  activate_mass_dataset(what = "sample_info") %>% 
  dplyr::filter(class == "QC")
object2
```

## Filter variables

Only remain variables which are not NA in QC_1.

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object2 = 
object %>% 
  activate_mass_dataset(what = "expression_data") %>% 
  dplyr::filter(!is.na(QC_1))
object2
```

Only remain variables with RSD > 30 in subject samples

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
subject_id = 
  object %>% 
  activate_mass_dataset(what = "sample_info") %>% 
  filter(class == "Subject") %>% 
  pull(sample_id)

object2 = 
object %>% 
  mutate_rsd(according_to_samples = subject_id) %>% 
  activate_mass_dataset(what = "variable_info") %>% 
  dplyr::filter(rsd > 50)
object2

extract_variable_info(object2) %>% 
  head()
```

# **mutate() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
###add new column in sample_info
object2 = 
  object %>% 
  activate_mass_dataset(what = "sample_info") %>% 
  mutate(sample_id2 = sample_id)
extract_sample_info(object2)

###add new column in variabe_info
object2 = 
  object %>% 
  activate_mass_dataset(what = "variable_info") %>% 
  mutate(variable_id2 = variable_id)
extract_variable_info(object2)

###add new samples in expression_data
object2 = 
  object %>% 
  activate_mass_dataset(what = "expression_data") %>% 
  mutate(new_sample = QC_2)
head(extract_expression_data(object2[,1:5]))
```



# **left_join() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
new_sample_info = 
  data.frame(sample_id = c("PS4P1", "PS4P2"), 
             BMI = c(20, 22))

object2 =
object %>% 
  activate_mass_dataset(what = "sample_info") %>% 
  left_join(new_sample_info, by = "sample_id")

extract_sample_info(object2) %>% head()
```


# **pull() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object %>% 
  activate_mass_dataset(what = "sample_info") %>% 
  pull(group)
```

# **rename() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object2 = 
object %>% 
  activate_mass_dataset(what = "expression_data") %>% 
  rename(Blank_10 = Blank_3)
colnames(object2)
extract_sample_info(object2)
```


# **arrange() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object2 = 
object %>% 
  activate_mass_dataset(what = "sample_info") %>% 
  arrange(desc(class))
extract_sample_info(object)
extract_sample_info(object2)
```
# **relocate() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object2 = 
object %>% 
  activate_mass_dataset(what = "expression_data") %>% 
  relocate(QC_1, everything())
colnames(object)
colnames(object2)
```

# **slice() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object %>%
  activate_mass_dataset(what = "expression_data") %>% 
  slice(1:10)

object %>%
  activate_mass_dataset(what = "expression_data") %>% 
  dplyr::arrange(QC_2) %>% 
  slice_head(n = 3)
```

# **select() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object2 =
  object %>%
  activate_mass_dataset(what = "expression_data") %>%
  select(-Blank_3)

colnames(object2)

object2 =
  object %>%
  activate_mass_dataset(what = "expression_data") %>%
  select(-contains("Blank"))
colnames(object2)
```


# **group_by() and summarize() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object %>% 
  activate_mass_dataset(what = "sample_info") %>% 
  group_by(class) %>% 
  summarise(n = n())
```

# **count() function**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object %>% 
  activate_mass_dataset(what = "sample_info") %>% 
  count(class)
```

# **drop_na() function**

`drop_na()` from `tidyr` package.

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object2 = 
object %>% 
  activate_mass_dataset(what = "expression_data") %>% 
  drop_na(QC_2)
object$QC_2
object2$QC_2
```


# **Session information**

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
sessionInfo()
```

